<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Consultant Payment</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="css/full-calendar.css"/>
    <link rel="stylesheet" href="css/grid.css"/>
    <link rel="stylesheet" href="css/main.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Armata"/>

    <script src="js/jquery.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/moment.js"></script>
    <!-- <script src="js/full-calendar.js"></script> -->
    <!-- <script src="https://js.braintreegateway.com/js/braintree-2.32.1.min.js"></script> -->
    <!-- <script src="https://js.braintreegateway.com/web/dropin/1.21.0/js/dropin.min.js"></script> -->
    <script src="https://www.paypal.com/sdk/js?client-id=ASS1g6isVnN46cbtSg7iy0KYMV1y-n8uzPDs0qSd34j1PT5sPxKV4zzd1LZ01rFAbjQR9sCdm89s_Rpm">
    </script>
    <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-firestore.js"></script>
</head>
<body>

<div class="my-model" id="myAlert" hidden>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-sm-6">
                <div class="my-div">
                    <div class="my-div-head">
                        <div class="my-div-head-left">
                            <h3 id="alertHeading">No heading available</h3>
                        </div>
                        <div>
                            <i id="alertCloseBtn" class="fa fa-times-circle"></i>
                        </div>
                    </div>
                    <div class="my-div-body">
                        <table>
                            <tbody>
                            <tr>
                                <td style="font-size: 50px">
                                    <i id="alertIcon"></i>
                                </td>
                                <td>
                                    <p id="alertMsg">No message available..... !</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="my-div-foot">
                        <div class="my-div-foot-left">
                            <button id="alertTryAgainBtn" class="my-btn">Try Again</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-sm-12">
            <div class="my-div">
                <div class="my-div-head justify-content-center">
                    <h3 style="text-align: center">Payment Portal</h3>
                </div>
                <div class="my-div-body" style="margin-top: 25px">
                    <div id="paypal-button-container"></div>
                    <!-- <div id="paypal-container"></div> -->
                </div>
                <!-- <div style="padding: 5px">
                    <div id="dropin-container"></div>
                </div>
                <div class="my-div-foot justify-content-center">
                    <button id="submit-button" class="my-btn">Complete Payment</button>
                </div> -->
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    $(document).ready(function () {

        let serverBaseUrl = "http://192.168.43.179:8080";
        let webClientBaseUrl = "http://192.168.43.132/consultationmanagementsystem/webclient";

        var firebaseConfig = {
            apiKey: "AIzaSyCds45N0E52JbAH2JSiwyWCsqEwnOlxCP0",
            authDomain: "consultant-e6956.firebaseapp.com",
            databaseURL: "https://consultant-e6956.firebaseio.com",
            projectId: "consultant-e6956",
            storageBucket: "consultant-e6956.appspot.com",
            messagingSenderId: "1008185790163",
            appId: "1:1008185790163:web:8b0846089683685c654e26",
            measurementId: "G-YQXJFTNYTQ"
        };

        // let serverBaseUrl = "http://3.20.119.226:8080";
        // let webClientBaseUrl = "http://3.20.119.226/cms/index.html";

        // alert configuration start
        $('#alertCloseBtn').click(function () {
            $('#myAlert').hide();
        });

        $('#alertCloseBtn').click(function () {
            $('#myAlert').hide();
        });

        function showAlert(data) {

            $('#myAlert').show();
            data.ntsTaBtn ? $('#alertTryAgainBtn').show() : $('#alertTryAgainBtn').hide();
            $('#alertIcon').removeClass();
            $('#alertIcon').addClass(data.bodyIcon);
            $('#alertHeading').text(data.alertHeading);
            $('#alertMsg').text(data.msg);

        }

        function hideAlert() {
            $('#myAlert').hide();
        }

        function updateCheckOutStatus(checkOutData) {
            
            $.ajax({
                url: serverBaseUrl + "/plan/update-check-out-status",
                type: "POST",
                contentType: 'application/json',
                data: JSON.stringify(checkOutData),
                success: function (s) {
                    console.log("success to update checkout = ",JSON.stringify(s));
                    redirectBack("true");
                },
                error: function (e) {
                    console.log("error to update checout = ",JSON.stringify(e));
                    redirectBack("true");
                }
            });

        }

        function redirectBack(isPaymentSuccess) {
            $('#myAlert').hide();
            let link = document.createElement('a');
            link.href = webClientBaseUrl+"/index.html?paymentstatus="+isPaymentSuccess;
            document.body.appendChild(link);
            link.click();
        }

        showAlert({
            msg: 'Please wait....!',
            bodyIcon: 'fa fa-refresh fa-spin',
            ntsTaBtn: false,
            alertHeading: 'Loading',
        });

        let amount = null;
        let planId = null;
        let conUid = null;
        let isUrlOk = false;

        let urlParameters = new URLSearchParams(window.location.search);

        if (urlParameters.has('amount') &&
            urlParameters.has('plan-id') &&
            urlParameters.has('con-uid')) {

            amount = urlParameters.get('amount');
            planId = urlParameters.get('plan-id');
            conUid = urlParameters.get('con-uid');
            isUrlOk = true;

        } else {

            isUrlOk = false;

        }

        // let authData = {
        //     auth: {
        //         aId: aId,
        //         uId: uId
        //     }
        // };

        if (isUrlOk) {

            $('#myAlert').hide();

            // $.ajax({
            //     url: serverBaseUrl + "/auth/check",
            //     type: "POST",
            //     contentType: 'application/json',
            //     data: JSON.stringify(authData),
            //     success: function (s) {

            //         if (s.code === 404) {

            //             window.location.replace(webClientBaseUrl)

            //         } else {

            //             console.log(JSON.stringify(s));
            //             $('#myAlert').hide();

            //             // show PayPal payment button
            //             braintree.setup(s.auth.clientToken, "custom", {
            //                 paypal: {
            //                     container: "paypal-container",
            //                 },
            //                 onPaymentMethodReceived: function (obj) {

            //                     console.log("nonce: " + obj.nonce);

            //                     let json = {
            //                         auth: {
            //                             aId: aId,
            //                             uId: uId
            //                         },
            //                         transaction: {
            //                             nonceFromTheClient: obj.nonce
            //                         }
            //                     };

            //                     checkout(json);
            //                 }
            //             });

            //             // show credit card ui
            //             braintree.dropin.create({
            //                 authorization: s.auth.clientToken,
            //                 container: '#dropin-container'
            //             }, function (createErr, instance) {
            //                 button.addEventListener('click', function () {
            //                     instance.requestPaymentMethod(function (err, obj) {

            //                         console.log("nonce: " + obj.nonce);

            //                         let json = {
            //                             auth: {
            //                                 aId: aId,
            //                                 uId: uId
            //                             },
            //                             transaction: {
            //                                 nonceFromTheClient: obj.nonce
            //                             }
            //                         };

            //                         checkout(json);

            //                     });
            //                 });
            //             });

            //             function checkout(json) {

            //                 $.ajax({
            //                     url: serverBaseUrl + "/pg/checkout",
            //                     type: "POST",
            //                     contentType: 'application/json',
            //                     data: JSON.stringify(json),
            //                     success: function (s) {

            //                         console.log(JSON.stringify(s));
            //                         let paymentstatus = "false";

            //                         if (s.code === 200) {

            //                             paymentstatus = "true";
            //                             showAlert({
            //                                 msg: s.msg,
            //                                 bodyIcon: 'fa fa-check-circle',
            //                                 ntsTaBtn: false,
            //                                 alertHeading: 'Success',
            //                             });

            //                         } else {

            //                             showAlert({
            //                                 msg: s.msg,
            //                                 bodyIcon: 'fa fa-exclamation-circle',
            //                                 ntsTaBtn: false,
            //                                 alertHeading: 'Error',
            //                             });

            //                         }

            //                         let link = document.createElement('a');
            //                         link.href = webClientBaseUrl+"/index.html?paymentstatus="+paymentstatus;
            //                         document.body.appendChild(link);
            //                         link.click();

            //                     },
            //                     error: function (e) {

            //                         console.log(JSON.stringify(e));
            //                         window.location.replace(webClientBaseUrl)

            //                     }
            //                 });

            //             }

            //         }

            //     },
            //     error: function (e) {

            //         console.log(JSON.stringify(e));
            //         window.location.replace(webClientBaseUrl)

            //     }
            // })

        } else {
            window.location.replace(webClientBaseUrl)
        }


        var consultant = firebase.initializeApp(firebaseConfig,"consultant");
        console.log(consultant.name); 
        var db = consultant.firestore();

        paypal.Buttons({
            createOrder: function(data, actions) {
              return actions.order.create({
                purchase_units: [{
                  amount: {
                    value: amount
                  }
                }]
              });
            },
            onApprove: function(data, actions) {

                showAlert({
                    msg: 'Please wait....!',
                    bodyIcon: 'fa fa-refresh fa-spin',
                    ntsTaBtn: false,
                    alertHeading: 'Loading',
                });
                    
                console.log("onApprove data = ",JSON.stringify(data));
                console.log("onApprove actions = ",JSON.stringify(actions));

                return actions.order.capture().then(function(details) {

                    let req = {
                        plan : {
                            id : planId,
                            checkOutId : details.id,
                            checkOutStatus : details.status,
                            checkOutCreatedDate : new Date(details.create_time),
                        }
                    };

                    if (details.status == "COMPLETED") {

                        var docRef = db.collection("userInfoList").doc(conUid);
                        docRef.get().then(function(doc) {

                            var d = new Date();
                            
                            if (doc.data().payPalEmail) {

                                let payoutData = {
                                    email : doc.data().payPalEmail,
                                    amount : amount
                                };

                                $.ajax({
                                    url: serverBaseUrl + "/pg/payout",
                                    type: "POST",
                                    contentType: 'application/json',
                                    data: JSON.stringify(payoutData),
                                    success: function (s) {
                                        console.log("ok to udt checkout if email = ",JSON.stringify(s));
                                        updateCheckOutStatus(req);
                                    },
                                    error: function (e) {
                                        console.log("er to udt checkout if email = ",JSON.stringify(e));
                                        updateCheckOutStatus(req);
                                    }
                                });

                            }else {

                                db.collection("notificationList").add({
                                    body : "Please give us your paypal email address if you don't have paypal account give us any valid email address.",
                                    fcmRegistrationToken : doc.data().fcmRegistrationToken,
                                    uid : conUid,
                                    timeStamp : d.getTime(),
                                    title : "Email Required For Payment",
                                    type : 7, 
                                    seenStatus : 0,
                                    amount : amount
                                }).then(function(s) {
                                    console.log("ok to send noti if not email = ",JSON.stringify(s));
                                    updateCheckOutStatus(req);
                                }).catch(function(e) {
                                    console.log("er to send noti if not email = ",JSON.stringify(e));
                                    updateCheckOutStatus(req);
                                });

                            }

                        });

                    }else{
                        redirectBack("false");
                    }

                });

            }
        }).render('#paypal-button-container');

    });

    // let button = document.querySelector('#submit-button');

</script>
</body>
</html>